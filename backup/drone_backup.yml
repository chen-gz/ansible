---
- name: Backup drone and upload to R2
  hosts: managed
  vars:
    bak_dir: "/tmp/"
    remote_bakup_file: "local/server-backup/drone.tar.gz"

  tasks:

    - name: Package drone files into one tar file
      become: true
      command:
        cmd: |
          tar -czvf {{ bak_dir }}/drone.tar.gz
          -C /
          var/lib/drone
          etc/systemd/system/drone-runner-docker.service.d
          etc/systemd/system/drone-runner-exec.service.d
          etc/systemd/system/drone.service.d

    - name: Upload drone backup file to minio
      command:
        cmd: "mcli cp {{ bak_dir}}/drone.tar.gz {{ remote_bakup_file }}"
