---
- name: Configure SSH
  hosts: pc
  vars:
    my_key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
    user: guangzong

  tasks:
    - name: add user to sudoer
      become: true
      lineinfile:
        path: /etc/sudoers
        regexp: "^# %wheel ALL=(ALL) ALL NOPASSWD: ALL"
        line: "%wheel ALL=(ALL) ALL NOPASSWD: ALL"
        validate: "visudo -cf %s"
    # remove sudo password for wheel user

    - name: Disable password login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication no"
      become: true

    - name: Update authorized keys
      authorized_key:
        user: "{{ user }}"
        state: present
        key: "{{ my_key }}"
      become: false

    - name: Restart SSH service
      service:
        name: sshd
        state: restarted
      become: true

    - name: Install fish shell
      package:
        name: fish
        state: present
      become: true
